# bot_manager.py
#
# –°–∏—Å—Ç–µ–º–∞ –±–æ—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
# –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å API https://renderfin.com/api-game-user/
# –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å API https://renderfin.com/api-game-queue/
# –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å API https://renderfin.com/api-game-match/
#
# –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–æ–ª—å–∫–æ –±–æ—Ç–æ–≤, —Å–∫–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–æ –≤ bots_count.
# –ë–æ—Ç—ã –∏–º–µ—é—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ player_id –¥–ª—è –æ—Ç–ª–∏—á–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤.

import requests
import json
import time
import random
import threading
from datetime import datetime, timedelta
from typing import Dict, List, Optional
import sqlite3
import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
API_BASE_URL = "https://renderfin.com"
ADMIN_TOKEN = "ZXCVBNM,1234567890"
bots_count = 50  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ—Ç–æ–≤ –¥–ª—è –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥–∞

# –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
HEADERS = {
    'Content-Type': 'application/json',
    'Authorization': f'Bearer {ADMIN_TOKEN}'
}

class Bot:
    """–ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º"""
    
    def __init__(self, bot_id: str, nick_name: str, email: str, password: str):
        self.bot_id = bot_id
        self.nick_name = nick_name
        self.email = email
        self.password = password
        self.is_active = True
        self.last_action_time = datetime.now()
        self.current_state = "idle"  # idle, in_queue, in_match
        self.current_match_id = None
        self.current_queue_ticket_id = None
        self.preferred_match_types = [1, 2, 4]  # OneVsOne, TwoVsTwo, FourPlayerFFA
        self.mmr_one_vs_one = 0
        self.mmr_two_vs_two = 0
        self.mmr_four_player_ffa = 0
        self.last_heartbeat = datetime.now()
        self.queue_join_interval = random.randint(15, 45)  # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤—Ö–æ–¥–∞ –≤ –æ—á–µ—Ä–µ–¥—å
        self.session = requests.Session()  # –°–µ—Å—Å–∏—è –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
        
    def __str__(self):
        return f"Bot({self.bot_id}, {self.nick_name}, {self.current_state})"

class BotManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –±–æ—Ç–æ–≤"""
    
    def __init__(self):
        self.bots: Dict[str, Bot] = {}
        self.bots_db_path = "bots_database.db"
        self.running = False
        self.threads = []
        self.stats = {
            'total_bots': 0,
            'active_bots': 0,
            'bots_in_queue': 0,
            'bots_in_match': 0,
            'matches_played': 0,
            'queue_attempts': 0,
            'api_errors': 0
        }
        self.init_bots_database()
        
    def init_bots_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤"""
        conn = sqlite3.connect(self.bots_db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bots_list (
                bot_id TEXT PRIMARY KEY,
                nick_name TEXT NOT NULL,
                email TEXT NOT NULL,
                password TEXT NOT NULL,
                matches_played INTEGER DEFAULT 0,
                wins INTEGER DEFAULT 0,
                losses INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_active TIMESTAMP
            )
        ''')
        
        conn.commit()
        conn.close()
        
    def save_bot_to_db(self, bot: Bot):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–æ—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.bots_db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT OR REPLACE INTO bots_list 
            (bot_id, nick_name, email, password, last_active)
            VALUES (?, ?, ?, ?, ?)
        ''', (
            bot.bot_id,
            bot.nick_name,
            bot.email,
            bot.password,
            datetime.now().isoformat()
        ))
        
        conn.commit()
        conn.close()
        
    def load_bots_from_db(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–æ—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        conn = sqlite3.connect(self.bots_db_path)
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM bots_list')
        rows = cursor.fetchall()
        
        for row in rows:
            bot_id, nick_name, email, password, matches_played, wins, losses, created_at, last_active = row
            
            bot = Bot(bot_id, nick_name, email, password)
            self.bots[bot_id] = bot
            
        conn.close()
        print(f"Loaded {len(self.bots)} bots from database")
        
    def create_bots(self):
        """–°–æ–∑–¥–∞–µ—Ç –±–æ—Ç–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏ bot_-{player_id}"""
        print(f"Creating {bots_count} bots...")
        
        for i in range(1, bots_count + 1):
            bot_id = f"bot_-{i}"  # –í—Ä–µ–º–µ–Ω–Ω—ã–π ID –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
            nick_name = f"Bot_Player_{i}"
            email = f"bot{i}@testbot.com"
            password = f"botpass{i}"
            
            # –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞
            bot = Bot(bot_id, nick_name, email, password)
            
            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ –∏–≥—Ä–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –∏ –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π ID
            real_player_id = self.register_bot_in_game(bot)
            if real_player_id:
                # –û–±–Ω–æ–≤–ª—è–µ–º ID –±–æ—Ç–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                bot.bot_id = real_player_id
                self.bots[real_player_id] = bot
                self.save_bot_to_db(bot)
                print(f"Created bot: {bot} (real ID: {real_player_id})")
            else:
                print(f"Failed to create bot: {bot_id}")
                
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–æ—Ç–æ–≤
            time.sleep(0.1)
            
        print(f"Successfully created {len(self.bots)} bots")
        
    def register_bot_in_game(self, bot: Bot) -> Optional[str]:
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –±–æ—Ç–∞ –≤ –∏–≥—Ä–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π player_id"""
        try:
            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ —Å–∏—Å—Ç–µ–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            response = bot.session.post(
                f"{API_BASE_URL}/api-game-player/register",
                json={
                    "username": bot.nick_name,
                    "email": bot.email,
                    "password": bot.password
                },
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get('success'):
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π player_id, –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–æ–º
                    real_player_id = str(data.get('user', {}).get('id'))
                    print(f"Bot registered successfully: {bot.nick_name} -> {real_player_id}")
                    return real_player_id
                else:
                    print(f"Registration failed for {bot.bot_id}: {data.get('message', 'Unknown error')}")
                    return None
            elif response.status_code == 400:
                print(f"Bot {bot.bot_id} might already exist - trying to login")
                # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                login_response = bot.session.post(
                    f"{API_BASE_URL}/api-game-player/login",
                    json={
                        "email": bot.email,
                        "password": bot.password
                    },
                    headers={'Content-Type': 'application/json'},
                    timeout=10
                )
                
                if login_response.status_code == 200:
                    login_data = login_response.json()
                    if login_data.get('success'):
                        real_player_id = str(login_data.get('user', {}).get('id'))
                        print(f"Bot logged in successfully: {bot.nick_name} -> {real_player_id}")
                        return real_player_id
                        
                print(f"Failed to login bot {bot.bot_id}")
                return None
            else:
                print(f"HTTP error {response.status_code} for {bot.bot_id}")
                return None
                
        except Exception as e:
            print(f"Error registering bot {bot.bot_id}: {e}")
            return None
            
    def bot_action_cycle(self, bot: Bot):
        """–¶–∏–∫–ª –¥–µ–π—Å—Ç–≤–∏–π –±–æ—Ç–∞"""
        last_heartbeat = 0
        last_queue_attempt = 0
        cycle_count = 0
        
        print(f"ü§ñ –ë–æ—Ç {bot.bot_id} –∑–∞–ø—É—â–µ–Ω –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ")
        
        while self.running and bot.is_active:
            try:
                cycle_count += 1
                current_time = time.time()
                
                # –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 100 —Ü–∏–∫–ª–æ–≤
                if cycle_count % 100 == 0:
                    print(f"üîÑ –ë–æ—Ç {bot.bot_id}: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ {cycle_count} —Ü–∏–∫–ª–æ–≤, —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {bot.current_state}")
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
                if current_time - last_heartbeat >= 60:
                    self.send_heartbeat(bot)
                    last_heartbeat = current_time
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
                self.check_bot_state(bot)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if bot.current_state == "idle":
                    # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –æ—á–µ—Ä–µ–¥–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
                    if current_time - last_queue_attempt >= bot.queue_join_interval:
                        if self.try_join_queue(bot):
                            last_queue_attempt = current_time
                            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
                            bot.queue_join_interval = random.randint(15, 45)
                        
                elif bot.current_state == "in_queue":
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏
                    self.check_queue_status(bot)
                    
                elif bot.current_state == "in_match":
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á–∞ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–≥—Ä—É
                    self.handle_match_actions(bot)
                    
                # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
                bot.last_action_time = datetime.now()
                
            except Exception as e:
                print(f"‚ùå Error in bot {bot.bot_id} cycle: {e}")
                self.stats['api_errors'] += 1
                
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –¥–µ–π—Å—Ç–≤–∏—è–º–∏
            time.sleep(5)
            
        print(f"‚ö†Ô∏è –ë–æ—Ç {bot.bot_id} –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É! –í—ã–ø–æ–ª–Ω–µ–Ω–æ {cycle_count} —Ü–∏–∫–ª–æ–≤. running={self.running}, is_active={bot.is_active}")
            
    def check_bot_state(self, bot: Bot):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
            response = bot.session.get(
                f"{API_BASE_URL}/api-game-player/{bot.bot_id}",
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get('success'):
                    user_data = data.get('user', {})
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –≤ –º–∞—Ç—á–µ –∏–ª–∏ –Ω–µ—Ç
                    current_match_id = user_data.get('currentMatchId')
                    is_in_queue = user_data.get('isInQueue', False)
                    
                    if current_match_id:
                        if bot.current_state != "in_match":
                            print(f"Bot {bot.bot_id} entered match #{current_match_id}")
                        bot.current_state = "in_match"
                        bot.current_match_id = current_match_id
                        bot.current_queue_ticket_id = None
                    elif is_in_queue:
                        if bot.current_state != "in_queue":
                            print(f"Bot {bot.bot_id} is in queue")
                        bot.current_state = "in_queue"
                        bot.current_match_id = None
                    else:
                        if bot.current_state != "idle":
                            print(f"Bot {bot.bot_id} is now idle")
                        bot.current_state = "idle"
                        bot.current_match_id = None
                        bot.current_queue_ticket_id = None
                        
        except Exception as e:
            print(f"Error checking bot state for {bot.bot_id}: {e}")
            self.stats['api_errors'] += 1
            
    def try_join_queue(self, bot: Bot):
        """–ü—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å"""
        try:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ç–∏–ø –º–∞—Ç—á–∞ –∏–∑ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã—Ö
            match_type = random.choice(bot.preferred_match_types)
            
            response = bot.session.post(
                f"{API_BASE_URL}/api-game-queue/{bot.bot_id}/join",
                json={
                    "matchType": match_type
                },
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                bot.current_state = "in_queue"
                print(f"Bot {bot.bot_id} joined queue for match type {match_type}")
                self.stats['queue_attempts'] += 1
                return True
            else:
                print(f"Failed to join queue for {bot.bot_id}: HTTP {response.status_code}")
                return False
                    
        except Exception as e:
            print(f"Error joining queue for {bot.bot_id}: {e}")
            self.stats['api_errors'] += 1
            return False
            
    def check_queue_status(self, bot: Bot):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥–∏"""
        try:
            response = bot.session.get(
                f"{API_BASE_URL}/api-game-queue/{bot.bot_id}/status",
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if not data.get('inQueue', False):
                    # –ë–æ—Ç –±–æ–ª—å—à–µ –Ω–µ –≤ –æ—á–µ—Ä–µ–¥–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –≤ –º–∞—Ç—á–µ –ª–∏ –æ–Ω
                    self.check_bot_state(bot)
                else:
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤ –æ—á–µ—Ä–µ–¥–∏
                    queue_time = data.get('queueTime', 0)
                    if queue_time > 30:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 30 —Å–µ–∫—É–Ω–¥
                        queue_type = data.get('queueType', 'unknown')
                        print(f"Bot {bot.bot_id} in queue for {queue_time}s (type: {queue_type})")
                        
        except Exception as e:
            print(f"Error checking queue status for {bot.bot_id}: {e}")
            self.stats['api_errors'] += 1
            
    def handle_match_actions(self, bot: Bot):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –±–æ—Ç–∞ –≤ –º–∞—Ç—á–µ"""
        try:
            if not bot.current_match_id:
                return
                
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ç—á–µ
            response = bot.session.get(
                f"{API_BASE_URL}/api-game-match/{bot.current_match_id}/status",
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                match_status = data.get('status')
                elapsed_time = data.get('elapsedTime', 0)
                
                # –ï—Å–ª–∏ –º–∞—Ç—á –∞–∫—Ç–∏–≤–µ–Ω (InProgress), –∏–º–∏—Ç–∏—Ä—É–µ–º –∏–≥—Ä—É
                if match_status == 0:  # GameMatchStatus.InProgress
                    # –ò–º–∏—Ç–∏—Ä—É–µ–º –∏–≥—Ä—É –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è, –ø–æ—Ç–æ–º –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å
                    if elapsed_time > 30:  # –ò–≥—Ä–∞–µ–º –º–∏–Ω–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥
                        if random.random() < 0.1:  # 10% —à–∞–Ω—Å –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ç—á
                            self.try_finish_match(bot)
                            
                # –ï—Å–ª–∏ –º–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                elif match_status in [1, 2]:  # Completed –∏–ª–∏ Cancelled
                    bot.current_state = "idle"
                    old_match_id = bot.current_match_id
                    bot.current_match_id = None
                    self.stats['matches_played'] += 1
                    print(f"Bot {bot.bot_id} finished match #{old_match_id}")
                        
        except Exception as e:
            print(f"Error handling match actions for {bot.bot_id}: {e}")
            self.stats['api_errors'] += 1
            
    def try_finish_match(self, bot: Bot):
        """–ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ç—á (–∏–º–∏—Ç–∏—Ä—É–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã)"""
        try:
            if not bot.current_match_id:
                return
                
            # –°–ª—É—á–∞–π–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—ã–∏–≥—Ä–∞–ª –ª–∏ –±–æ—Ç
            is_winner = random.choice([True, False])
            
            if is_winner:
                winners = [int(bot.bot_id)]
                losers = []  # –î—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Å–µ—Ä–≤–µ—Ä
            else:
                winners = []
                losers = [int(bot.bot_id)]
            
            response = bot.session.post(
                f"{API_BASE_URL}/api-game-match/{bot.current_match_id}/finish",
                json={
                    "winners": winners,
                    "losers": losers
                },
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                result = "–≤—ã–∏–≥—Ä–∞–ª" if is_winner else "–ø—Ä–æ–∏–≥—Ä–∞–ª"
                print(f"Bot {bot.bot_id} finished match #{bot.current_match_id} - {result}")
            else:
                print(f"Failed to finish match for bot {bot.bot_id}: HTTP {response.status_code}")
                
        except Exception as e:
            print(f"Error finishing match for {bot.bot_id}: {e}")
            self.stats['api_errors'] += 1
            
    def send_heartbeat(self, bot: Bot):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞"""
        try:
            response = bot.session.post(
                f"{API_BASE_URL}/api-game-player/heartbeat",
                json={"userId": int(bot.bot_id)},
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                bot.last_heartbeat = datetime.now()
            else:
                print(f"Heartbeat failed for bot {bot.bot_id}: HTTP {response.status_code}")
                
        except Exception as e:
            print(f"Error sending heartbeat for {bot.bot_id}: {e}")
            self.stats['api_errors'] += 1
            
    def update_stats(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–æ–≤"""
        self.stats['total_bots'] = len(self.bots)
        self.stats['active_bots'] = sum(1 for bot in self.bots.values() if bot.is_active)
        self.stats['bots_in_queue'] = sum(1 for bot in self.bots.values() if bot.current_state == "in_queue")
        self.stats['bots_in_match'] = sum(1 for bot in self.bots.values() if bot.current_state == "in_match")
        
    def print_stats(self):
        """–í—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–±–æ—Ç—ã –±–æ—Ç–æ–≤"""
        self.update_stats()
        print("\n" + "="*50)
        print("BOT MANAGER STATISTICS")
        print("="*50)
        print(f"ü§ñ Total bots: {self.stats['total_bots']}")
        print(f"‚úÖ Active bots: {self.stats['active_bots']}")
        print(f"‚è≥ Bots in queue: {self.stats['bots_in_queue']}")
        print(f"üéÆ Bots in match: {self.stats['bots_in_match']}")
        print(f"üèÜ Matches played: {self.stats['matches_played']}")
        print(f"üéØ Queue attempts: {self.stats['queue_attempts']}")
        print(f"‚ùå API errors: {self.stats['api_errors']}")
        print(f"üîÑ System running: {self.running}")
        print("="*50)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –±–æ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã
        inactive_bots = [bot for bot in self.bots.values() if not bot.is_active]
        if inactive_bots:
            print(f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: {len(inactive_bots)} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤!")
            for bot in inactive_bots[:5]:
                print(f"  - {bot.bot_id}: –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")
        
        # –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–∞—Ö
        print("\nBOT STATES:")
        for bot_id, bot in list(self.bots.items())[:10]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã—Ö 10 –±–æ—Ç–æ–≤
            status = "‚úÖ" if bot.is_active else "‚ùå"
            print(f"  {status} {bot_id}: {bot.current_state}")
            
    def start(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –±–æ—Ç–æ–≤"""
        print("üöÄ Starting Bot Manager...")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–æ—Ç–æ–≤
        self.load_bots_from_db()
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã—Ö –±–æ—Ç–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if len(self.bots) < bots_count:
            self.create_bots()
            
        # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –≤—Å–µ –±–æ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã
        for bot in self.bots.values():
            bot.is_active = True
            print(f"‚úÖ –ë–æ—Ç {bot.bot_id} –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")
            
        self.running = True
        print(f"üîÑ –°–∏—Å—Ç–µ–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ –ë–ï–°–ö–û–ù–ï–ß–ù–£–Æ —Ä–∞–±–æ—Ç—É (running={self.running})")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
        for bot in self.bots.values():
            thread = threading.Thread(target=self.bot_action_cycle, args=(bot,), daemon=True)
            thread.start()
            self.threads.append(thread)
            print(f"üßµ –ó–∞–ø—É—â–µ–Ω –ø–æ—Ç–æ–∫ –¥–ª—è –±–æ—Ç–∞ {bot.bot_id}")
            
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats_thread = threading.Thread(target=self.stats_loop, daemon=True)
        stats_thread.start()
        
        print(f"‚úÖ Bot Manager —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω —Å {len(self.bots)} –±–æ—Ç–∞–º–∏")
        print(f"üßµ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤: {len(self.threads)} + 1 (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)")
        print("üîÑ –í—Å–µ –±–æ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –ë–ï–°–ö–û–ù–ï–ß–ù–û–ú —Ä–µ–∂–∏–º–µ!")
        
    def stats_loop(self):
        """–¶–∏–∫–ª –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        stats_iteration = 0
        print("üìä –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
        
        while self.running:
            time.sleep(30)  # –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            stats_iteration += 1
            print(f"üìä –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ #{stats_iteration}:")
            self.print_stats()
            
        print("üìä –¶–∏–∫–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω")
            
    def stop(self):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –±–æ—Ç–æ–≤"""
        print("Stopping Bot Manager...")
        self.running = False
        
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –∏–∑ –æ—á–µ—Ä–µ–¥–µ–π
        for bot in self.bots.values():
            try:
                requests.delete(
                    f"{API_BASE_URL}/api-game-queue/",
                    json={"player_id": bot.bot_id},
                    headers={'Content-Type': 'application/json'},
                    timeout=5
                )
            except:
                pass
                
        print("Bot Manager stopped")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–æ—Ç–æ–≤
bot_manager = BotManager()

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã –±–æ—Ç–æ–≤"""
    try:
        print("üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –±–æ—Ç–æ–≤...")
        bot_manager.start()
        
        print("\n‚úÖ Bot Manager –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–°–ö–û–ù–ï–ß–ù–û!")
        print("üîÑ –ë–æ—Ç—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è Ctrl+C")
        print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–≤–æ–¥–∏—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥")
        print("üîç –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C...")
        
        # –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ - –ë–ï–°–ö–û–ù–ï–ß–ù–´–ô –¶–ò–ö–õ
        iteration = 0
        while True:
            iteration += 1
            time.sleep(10)
            
            # –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –º—ã –∂–∏–≤—ã
            if iteration % 3 == 0:
                print(f"üíì –°–∏—Å—Ç–µ–º–∞ –±–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç... (–∏—Ç–µ—Ä–∞—Ü–∏—è {iteration})")
            
    except KeyboardInterrupt:
        print("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Ctrl+C)...")
        bot_manager.stop()
        print("‚úÖ Bot Manager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ main(): {e}")
        bot_manager.stop()
        print("‚ö†Ô∏è Bot Manager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏!")

if __name__ == "__main__":
    main()





